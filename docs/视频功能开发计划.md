# 视频功能开发计划

## 项目概述
开发一个简化版抖音视频平台，核心功能包括视频上传、转码处理、视频流展示、用户互动等。

## 整体技术架构

### 核心服务组件
- **FastAPI**: Web服务端框架
- **PostgreSQL**: 主数据库，存储视频元数据、用户信息等
- **MinIO**: 对象存储，分别用私有桶存储原视频、公共桶存储转码后视频
- **Kafka**: 消息队列，异步处理转码任务
- **Celery**: 分布式任务队列，执行转码等耗时操作
- **FFmpeg**: 视频转码和封面提取工具

### 数据库设计

#### Videos 表（核心视频表）
```sql
CREATE TABLE videos (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '视频标识',
    author_id BIGINT NOT NULL COMMENT '视频作者id，外键到users表',
    play_url VARCHAR(500) NOT NULL COMMENT '视频播放地址',
    cover_url VARCHAR(500) NOT NULL COMMENT '视频封面地址',
    favorite_count BIGINT DEFAULT 0 COMMENT '视频点赞数量',
    comment_count BIGINT DEFAULT 0 COMMENT '视频评论数量',
    publish_time BIGINT COMMENT '发布时间',
    title VARCHAR(200) COMMENT '视频标题',
    status VARCHAR(20) DEFAULT 'pending' COMMENT '视频状态：pending-待转码，published-已发布',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (author_id) REFERENCES users(id)
);
```

#### Favorites 表（点赞表）
```sql
CREATE TABLE favorites (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL COMMENT '点赞用户ID',
    video_id BIGINT NOT NULL COMMENT '被点赞视频ID',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY unique_user_video (user_id, video_id),
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (video_id) REFERENCES videos(id)
);
```

#### Comments 表（评论表）
```sql
CREATE TABLE comments (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL COMMENT '评论用户ID',
    video_id BIGINT NOT NULL COMMENT '被评论视频ID',
    content TEXT NOT NULL COMMENT '评论内容',
    parent_id BIGINT DEFAULT NULL COMMENT '父评论ID，用于回复',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (video_id) REFERENCES videos(id),
    FOREIGN KEY (parent_id) REFERENCES comments(id)
);
```

## 开发阶段规划

### 第一阶段：基础设施建设
**周期**: 1-2天
**目标**: 搭建视频存储、消息队列、异步任务处理等基础架构

#### 1.1 MinIO 配置与封装
- [ ] 创建私有桶（raw-videos）和公共桶（public-videos）
- [ ] 封装 MinIO 客户端工具类
- [ ] 实现文件上传、下载、删除、URL生成等基础方法

#### 1.2 Kafka 消息队列配置
- [ ] 配置 Kafka 生产者
- [ ] 配置 Kafka 消费者
- [ ] 定义转码任务消息格式

#### 1.3 Celery 异步任务配置
- [ ] 配置 Celery 应用
- [ ] 配置 FFmpeg 转码任务
- [ ] 配置数据库更新任务

#### 1.4 数据库迁移
- [ ] 创建 Videos、Favorites、Comments 表
- [ ] 设置外键约束和触发器
- [ ] 创建必要的索引

### 第二阶段：核心视频功能实现 ⭐
**周期**: 3-4天
**目标**: 实现「上传→转码→播放」核心链路

#### 2.1 视频上传接口
- [ ] POST `/api/v1/videos/upload`
- [ ] 文件验证（格式、大小、时长）
- [ ] 上传到 MinIO 私有桶
- [ ] 写入数据库视频元数据
- [ ] 发送 Kafka 转码任务消息
- [ ] 返回上传结果

```python
# 接口请求示例
POST /api/v1/videos/upload
Headers: { "Authorization": "Bearer token" }
Body: FormData
- video_file: 视频文件
- title: 视频标题

# 接口响应示例  
{
    "success": true,
    "message": "视频上传成功",
    "data": {
        "video_id": 123,
        "upload_url": "minio-private-link"
    }
}
```

#### 2.2 视频转码异步任务
- [ ] 监听 Kafka 转码消息队列
- [ ] 下载原始视频到临时目录
- [ ] 调用 FFmpeg 执行转码（720p MP4）
- [ ] 生成视频封面
- [ ] 上传转码后视频到 MinIO 公共桶
- [ ] 上传封面到 MinIO 公共桶
- [ ] 更新数据库 video 记录
- [ ] 标记视频状态为已发布

```python
# 转码任务流程
def video_transcode_task(raw_video_id, raw_file_path):
    # 1. 验证原文件
    # 2. 调用FFmpeg转码
    # 3. 生成封面
    # 4. 上传到MinIO公共桶
    # 5. 更新数据库
    # 6. 清理临时文件
```

#### 2.3 视频流接口（刷视频）
- [ ] GET `/api/v1/videos/feed`
- [ ] 分页查询已发布视频
- [ ] 关联查询用户信息
- [ ] 返回视频元数据和播放地址
- [ ] 实现基础的分页机制

```python
# 接口请求示例
GET /api/v1/videos/feed?page=1&page_size=20

# 接口响应示例
{
    "success": true,
    "message": "获取成功",
    "data": [{
        "id": 123,
        "play_url": "https://minio-public/video.mp4",
        "cover_url": "https://minio-public/cover.jpg",
        "title": "有趣的视频",
        "author": {
            "id": 456,
            "username": "user123",
            "avatar": "https://example.com/avatar.jpg"
        }
    }],
    "meta": {
        "page": 1,
        "page_size": 20,
        "total": 100
    }
}
```

### 第三阶段：互动功能实现
**周期**: 2-3天
**目标**: 实现点赞、评论等用户互动功能

#### 3.1 视频点赞接口
- [ ] POST `/api/v1/videos/{video_id}/favorite` - 点赞/取消点赞
- [ ] GET `/api/v1/videos/{video_id}/favorites` - 获取点赞列表
- [ ] 异步更新视频点赞数
- [ ] 防止重复点赞

#### 3.2 视频评论接口
- [ ] POST `/api/v1/videos/{video_id}/comments` - 发布评论
- [ ] GET `/api/v1/videos/{video_id}/comments` - 获取评论列表
- [ ] DELETE `/api/v1/comments/{comment_id}` - 删除评论
- [ ] 异步更新视频评论数

#### 3.3 播放量统计接口
- [ ] POST `/api/v1/videos/{video_id}/view`
- [ ] 异步更新播放量
- [ ] 防刷机制（同一用户/设备限频次）

### 第四阶段：视频管理功能
**周期**: 1-2天
**目标**: 实现作者对视频的管理功能

#### 4.1 作者视频列表接口
- [ ] GET `/api/v1/videos/my`
- [ ] 查询当前用户的所有视频
- [ ] 显示视频状态（待转码/已发布）
- [ ] 显示转码进度

#### 4.2 视频管理接口
- [ ] DELETE `/api/v1/videos/{video_id}` - 删除视频
- [ ] PUT `/api/v1/videos/{video_id}` - 更新视频信息
- [ ] 清理 MinIO 文件

### 第五阶段：性能优化
**周期**: 1天
**目标**: 提升系统性能和用户体验

#### 5.1 缓存优化
- [ ] 视频列表 Redis 缓存
- [ ] 用户信息缓存
- [ ] 热门视频缓存

#### 5.2 分页优化
- [ ] 游标分页替代偏移分页
- [ ] 防重复分页机制
- [ ] 预加载下一页

#### 5.3 异步处理优化
- [ ] 播放量批处理更新
- [ ] 转码任务优先级队列
- [ ] 失败任务重试机制

## API 接口清单

### 核心功能接口
- `POST /api/v1/videos/upload` - 视频上传
- `GET /api/v1/videos/feed` - 视频流
- `POST /api/v1/videos/{video_id}/view` - 播放统计

### 互动功能接口
- `POST /api/v1/videos/{video_id}/favorite` - 点赞/取消点赞  
- `GET /api/v1/videos/{video_id}/favorites` - 获取点赞列表
- `POST /api/v1/videos/{video_id}/comments` - 发布评论
- `GET /api/v1/videos/{video_id}/comments` - 获取评论列表

### 管理功能接口
- `GET /api/v1/videos/my` - 我的视频列表
- `DELETE /api/v1/videos/{video_id}` - 删除视频
- `PUT /api/v1/videos/{video_id}` - 更新视频

## 配置和依赖

### 环境变量新增
```bash
# MinIO配置
MINIO_ENDPOINT=localhost:9000
MINIO_ACCESS_KEY=your_access_key
MINIO_SECRET_KEY=your_secret_key
MINIO_RAW_BUCKET=raw-videos
MINIO_PUBLIC_BUCKET=public-videos

# Kafka配置
KAFKA_BOOTSTRAP_SERVERS=localhost:9092
KAFKA_TRANSCODE_TOPIC=video-transcode-tasks

# Celery配置
CELERY_BROKER_URL=redis://localhost:6379/0
CELERY_RESULT_BACKEND=redis://localhost:6379/0

# FFmpeg配置
FFMPEG_PATH=/usr/bin/ffmpeg
TEMP_DIR=/tmp/video-transcode
```

### 新增依赖
```txt
minio==7.1.16
kafka-python==2.0.2
celery==5.3.4  
ffmpeg-python==0.2.0
```

## 测试策略

### 单元测试
- [ ] 视频上传验证逻辑
- [ ] MinIO 客户端方法
- [ ] 视频转码任务
- [ ] 分页查询逻辑

### 集成测试
- [ ] 完整上传→转码→播放链路
- [ ] 数据库事务测试
- [ ] MinIO 文件操作
- [ ] Kafka 消息流转

### 压力测试
- [ ] 并发上传测试
- [ ] 视频流分页性能测试
- [ ] 转码任务并发测试

## 里程碑和时间线

- **第1周**: 完成基础设施建设 + 视频上传接口
- **第2周**: 完成视频转码任务 + 视频流接口  
- **第3周**: 完成互动功能 + 管理功能
- **第4周**: 性能优化 + 测试完善

## 风险与应对

1. **大文件上传超时**: 实现断点续传或分片上传
2. **转码处理时间过长**: 优化转码参数，增加进度反馈
3. **MinIO 存储成本高**: 定期清理原视频，只保留转码后视频
4. **并发转码资源不足**: 使用 Redis 限制并发转码任务数量